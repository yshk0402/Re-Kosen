{"version":3,"file":"register.js","sources":["../../server/src/register.ts"],"sourcesContent":["import type { Core } from '@strapi/types';\nimport { CSP_DEFAULTS, extendMiddlewareConfiguration } from '@strapi/utils';\n\nexport default async ({ strapi }: { strapi: Core.Strapi }) => {\n  const aiEnabledConfig = strapi.config.get('admin.ai.enabled') !== false;\n  const isAIEnabled = aiEnabledConfig && strapi.ee.features.isEnabled('cms-ai');\n\n  if (isAIEnabled) {\n    const s3Domains = [\n      'strapi-ai-staging.s3.us-east-1.amazonaws.com',\n      'strapi-ai-production.s3.us-east-1.amazonaws.com',\n    ];\n\n    const defaultImgSrc = CSP_DEFAULTS['img-src'];\n    const defaultMediaSrc = CSP_DEFAULTS['media-src'];\n\n    // Extend the security middleware configuration to include S3 domains + defaults\n    const middlewares = strapi.config.get('middlewares') as (\n      | string\n      | { name?: string; config?: any }\n    )[];\n\n    const configuredMiddlewares = extendMiddlewareConfiguration(middlewares, {\n      name: 'strapi::security',\n      config: {\n        contentSecurityPolicy: {\n          directives: {\n            'img-src': [...defaultImgSrc, ...s3Domains],\n            'media-src': [...defaultMediaSrc, ...s3Domains],\n          },\n        },\n      },\n    });\n\n    strapi.config.set('middlewares', configuredMiddlewares);\n  }\n};\n"],"names":["strapi","aiEnabledConfig","config","get","isAIEnabled","ee","features","isEnabled","s3Domains","defaultImgSrc","CSP_DEFAULTS","defaultMediaSrc","middlewares","configuredMiddlewares","extendMiddlewareConfiguration","name","contentSecurityPolicy","directives","set"],"mappings":";;;;AAGA,eAAe,CAAA,OAAO,EAAEA,MAAM,EAA2B,GAAA;AACvD,IAAA,MAAMC,kBAAkBD,MAAOE,CAAAA,MAAM,CAACC,GAAG,CAAC,kBAAwB,CAAA,KAAA,KAAA;IAClE,MAAMC,WAAAA,GAAcH,mBAAmBD,MAAOK,CAAAA,EAAE,CAACC,QAAQ,CAACC,SAAS,CAAC,QAAA,CAAA;AAEpE,IAAA,IAAIH,WAAa,EAAA;AACf,QAAA,MAAMI,SAAY,GAAA;AAChB,YAAA,8CAAA;AACA,YAAA;AACD,SAAA;QAED,MAAMC,aAAAA,GAAgBC,kBAAY,CAAC,SAAU,CAAA;QAC7C,MAAMC,eAAAA,GAAkBD,kBAAY,CAAC,WAAY,CAAA;;AAGjD,QAAA,MAAME,WAAcZ,GAAAA,MAAAA,CAAOE,MAAM,CAACC,GAAG,CAAC,aAAA,CAAA;QAKtC,MAAMU,qBAAAA,GAAwBC,oCAA8BF,WAAa,EAAA;YACvEG,IAAM,EAAA,kBAAA;YACNb,MAAQ,EAAA;gBACNc,qBAAuB,EAAA;oBACrBC,UAAY,EAAA;wBACV,SAAW,EAAA;AAAIR,4BAAAA,GAAAA,aAAAA;AAAkBD,4BAAAA,GAAAA;AAAU,yBAAA;wBAC3C,WAAa,EAAA;AAAIG,4BAAAA,GAAAA,eAAAA;AAAoBH,4BAAAA,GAAAA;AAAU;AACjD;AACF;AACF;AACF,SAAA,CAAA;AAEAR,QAAAA,MAAAA,CAAOE,MAAM,CAACgB,GAAG,CAAC,aAAeL,EAAAA,qBAAAA,CAAAA;AACnC;AACF,CAAA;;;;"}