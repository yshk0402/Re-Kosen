{"version":3,"file":"content-types.js","sources":["../../../server/src/controllers/content-types.ts"],"sourcesContent":["import _ from 'lodash';\nimport type { Context } from 'koa';\nimport type {} from 'koa-body';\nimport type { Internal } from '@strapi/types';\nimport { getService } from '../utils';\nimport {\n  validateContentTypeInput,\n  validateUpdateContentTypeInput,\n  validateKind,\n} from './validation/content-type';\nimport { isContentTypeVisible } from '../services/content-types';\n\nexport default {\n  async getContentTypes(ctx: Context) {\n    const { kind } = ctx.query;\n\n    try {\n      await validateKind(kind);\n    } catch (error) {\n      return ctx.send({ error }, 400);\n    }\n\n    const contentTypeService = getService('content-types');\n\n    const contentTypes = Object.keys(strapi.contentTypes)\n      .filter(\n        (uid) =>\n          !kind ||\n          _.get(strapi.contentTypes[uid as Internal.UID.ContentType], 'kind', 'collectionType') ===\n            kind\n      )\n      .map((uid) =>\n        contentTypeService.formatContentType(strapi.contentTypes[uid as Internal.UID.ContentType])\n      );\n\n    ctx.send({\n      data: contentTypes,\n    });\n  },\n\n  getContentType(ctx: Context) {\n    const { uid } = ctx.params;\n\n    const contentType = strapi.contentTypes[uid];\n\n    if (!contentType) {\n      return ctx.send({ error: 'contentType.notFound' }, 404);\n    }\n\n    if (!isContentTypeVisible(contentType)) {\n      return ctx.send({ error: 'contentType.notFound' }, 404);\n    }\n\n    const contentTypeService = getService('content-types');\n\n    ctx.send({ data: contentTypeService.formatContentType(contentType) });\n  },\n\n  async createContentType(ctx: Context) {\n    const body = ctx.request.body as any;\n\n    try {\n      await validateContentTypeInput(body);\n    } catch (error) {\n      return ctx.send({ error }, 400);\n    }\n\n    try {\n      strapi.reload.isWatching = false;\n\n      const contentTypeService = getService('content-types');\n\n      const contentType = await contentTypeService.createContentType({\n        contentType: body.contentType,\n        components: body.components,\n      });\n\n      const metricsPayload = {\n        eventProperties: {\n          kind: contentType.kind,\n        },\n      };\n\n      if (_.isEmpty(strapi.apis)) {\n        await strapi.telemetry.send('didCreateFirstContentType', metricsPayload);\n      } else {\n        await strapi.telemetry.send('didCreateContentType', metricsPayload);\n      }\n\n      setImmediate(() => strapi.reload());\n\n      ctx.send({ data: { uid: contentType.uid } }, 201);\n    } catch (err) {\n      strapi.log.error(err);\n      await strapi.telemetry.send('didNotCreateContentType', {\n        eventProperties: { error: (err as Error).message || err },\n      });\n      ctx.send({ error: (err as Error).message || 'Unknown error' }, 400);\n    }\n  },\n\n  async updateContentType(ctx: Context) {\n    const { uid } = ctx.params;\n    const body = ctx.request.body as any;\n\n    if (!_.has(strapi.contentTypes, uid)) {\n      return ctx.send({ error: 'contentType.notFound' }, 404);\n    }\n\n    try {\n      await validateUpdateContentTypeInput(body);\n    } catch (error) {\n      return ctx.send({ error }, 400);\n    }\n\n    try {\n      strapi.reload.isWatching = false;\n\n      const contentTypeService = getService('content-types');\n\n      const component = await contentTypeService.editContentType(uid, {\n        contentType: body.contentType,\n        components: body.components,\n      });\n\n      setImmediate(() => strapi.reload());\n\n      ctx.send({ data: { uid: component.uid } }, 201);\n    } catch (error) {\n      strapi.log.error(error);\n      ctx.send({ error: (error as Error)?.message || 'Unknown error' }, 400);\n    }\n  },\n\n  async deleteContentType(ctx: Context) {\n    const { uid } = ctx.params;\n\n    if (!_.has(strapi.contentTypes, uid)) {\n      return ctx.send({ error: 'contentType.notFound' }, 404);\n    }\n\n    try {\n      strapi.reload.isWatching = false;\n\n      const contentTypeService = getService('content-types');\n\n      const component = await contentTypeService.deleteContentType(uid);\n\n      setImmediate(() => strapi.reload());\n\n      ctx.send({ data: { uid: component.uid } });\n    } catch (error) {\n      strapi.log.error(error);\n      ctx.send({ error: (error as Error)?.message || 'Unknown error' }, 400);\n    }\n  },\n};\n"],"names":["getContentTypes","ctx","kind","query","validateKind","error","send","contentTypeService","getService","contentTypes","Object","keys","strapi","filter","uid","_","get","map","formatContentType","data","getContentType","params","contentType","isContentTypeVisible","createContentType","body","request","validateContentTypeInput","reload","isWatching","components","metricsPayload","eventProperties","isEmpty","apis","telemetry","setImmediate","err","log","message","updateContentType","has","validateUpdateContentTypeInput","component","editContentType","deleteContentType"],"mappings":"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"}