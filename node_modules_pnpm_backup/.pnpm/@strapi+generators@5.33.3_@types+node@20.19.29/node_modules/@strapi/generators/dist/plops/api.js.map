{"version":3,"file":"api.js","sources":["../../src/plops/api.ts"],"sourcesContent":["import { join } from 'path';\nimport type { ActionType, NodePlopAPI } from 'plop';\nimport fs from 'fs-extra';\nimport tsUtils from '@strapi/typescript-utils';\n\nimport validateInput from './utils/validate-input';\nimport getFilePath from './utils/get-file-path';\nimport { appendToFile } from './utils/extend-plugin-index-files';\n\nexport default (plop: NodePlopAPI) => {\n  // API generator\n  plop.setGenerator('api', {\n    description: 'Generate a basic API',\n    prompts: [\n      {\n        type: 'input',\n        name: 'id',\n        message: 'API name',\n        validate: (input) => validateInput(input),\n      },\n      {\n        type: 'confirm',\n        name: 'isPluginApi',\n        message: 'Is this API for a plugin?',\n      },\n      {\n        when: (answers) => answers.isPluginApi,\n        type: 'list',\n        name: 'plugin',\n        message: 'Plugin name',\n        async choices() {\n          const pluginsPath = join(plop.getDestBasePath(), 'plugins');\n          const exists = await fs.pathExists(pluginsPath);\n          if (!exists) {\n            throw Error('Couldn\\'t find a \"plugins\" directory');\n          }\n\n          const pluginsDir = await fs.readdir(pluginsPath, { withFileTypes: true });\n          const pluginsDirContent = pluginsDir.filter((fd) => fd.isDirectory());\n\n          if (pluginsDirContent.length === 0) {\n            throw Error('The \"plugins\" directory is empty');\n          }\n\n          return pluginsDirContent;\n        },\n      },\n    ],\n    actions(answers) {\n      if (!answers) {\n        return [];\n      }\n\n      const filePath = getFilePath(\n        answers.destination || (answers.isPluginApi && answers.plugin ? 'plugin' : 'api')\n      );\n      const currentDir = process.cwd();\n      let language = tsUtils.isUsingTypeScriptSync(currentDir) ? 'ts' : 'js';\n\n      if (answers.plugin) {\n        // The tsconfig in plugins is located just outside the server src, not in the root of the plugin.\n        const pluginServerDir = join(\n          currentDir,\n          'src',\n          filePath.replace('{{ plugin }}', answers.plugin),\n          '../'\n        );\n        language = tsUtils.isUsingTypeScriptSync(pluginServerDir) ? 'ts' : 'js';\n      }\n\n      const baseActions: Array<ActionType> = [\n        {\n          type: 'add',\n          path: `${filePath}/controllers/{{ id }}.${language}`,\n          templateFile: `templates/${language}/controller.${language}.hbs`,\n        },\n        {\n          type: 'add',\n          path: `${filePath}/services/{{ id }}.${language}`,\n          templateFile: `templates/${language}/service.${language}.hbs`,\n        },\n        {\n          type: 'add',\n          path: `${filePath}/routes/${answers.plugin ? 'content-api/' : ''}{{ id }}.${language}`,\n          templateFile: `templates/${language}/single-route.${language}.hbs`,\n        },\n      ];\n\n      if (answers.isPluginApi) {\n        const indexFiles = ['controllers', 'services', 'routes'];\n\n        indexFiles.forEach((type) => {\n          const indexPath = join(plop.getDestBasePath(), `${filePath}/${type}/index.${language}`);\n          const exists = fs.existsSync(indexPath);\n\n          if (!exists && type !== 'routes') {\n            baseActions.push({\n              type: 'add',\n              path: `${filePath}/${type}/index.${language}`,\n              templateFile: `templates/${language}/plugin/plugin.index.${language}.hbs`,\n              skipIfExists: true,\n            });\n          }\n\n          if (type === 'routes') {\n            const indexPath = join(plop.getDestBasePath(), `${filePath}/${type}/index.${language}`);\n            const exists = fs.existsSync(indexPath);\n\n            if (!exists) {\n              baseActions.push({\n                type: 'add',\n                path: `${filePath}/${type}/index.${language}`,\n                templateFile: `templates/${language}/plugin/plugin.routes.index.${language}.hbs`,\n                skipIfExists: true,\n              });\n            }\n\n            const routeIndexFiles = ['content-api', 'admin'];\n\n            routeIndexFiles.forEach((routeType) => {\n              const routeTypeIndexPath = join(\n                plop.getDestBasePath(),\n                `${filePath}/${type}/${routeType}/index.${language}`\n              );\n              const routeTypeExists = fs.existsSync(routeTypeIndexPath);\n\n              if (!routeTypeExists) {\n                baseActions.push({\n                  type: 'add',\n                  path: `${filePath}/${type}/${routeType}/index.${language}`,\n                  templateFile: `templates/${language}/plugin/plugin.routes.type.index.${language}.hbs`,\n                  data: { type: routeType },\n                  skipIfExists: true,\n                });\n              }\n            });\n          }\n\n          baseActions.push({\n            type: 'modify',\n            path: `${filePath}/${type}/${type === 'routes' ? 'content-api/' : ''}index.${language}`,\n            transform(template: string) {\n              if (type === 'routes') {\n                return appendToFile(template, { type: 'routes', singularName: answers.id });\n              }\n\n              return appendToFile(template, { type: 'index', singularName: answers.id });\n            },\n          });\n        });\n      }\n\n      return baseActions;\n    },\n  });\n};\n"],"names":["plop","setGenerator","description","prompts","type","name","message","validate","input","validateInput","when","answers","isPluginApi","choices","pluginsPath","join","getDestBasePath","exists","fs","pathExists","Error","pluginsDir","readdir","withFileTypes","pluginsDirContent","filter","fd","isDirectory","length","actions","filePath","getFilePath","destination","plugin","currentDir","process","cwd","language","tsUtils","isUsingTypeScriptSync","pluginServerDir","replace","baseActions","path","templateFile","indexFiles","forEach","indexPath","existsSync","push","skipIfExists","routeIndexFiles","routeType","routeTypeIndexPath","routeTypeExists","data","transform","template","appendToFile","singularName","id"],"mappings":"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"}