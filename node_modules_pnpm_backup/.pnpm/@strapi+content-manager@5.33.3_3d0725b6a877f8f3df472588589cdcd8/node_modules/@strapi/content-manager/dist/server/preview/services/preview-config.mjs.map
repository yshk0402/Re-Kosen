{"version":3,"file":"preview-config.mjs","sources":["../../../../server/src/preview/services/preview-config.ts"],"sourcesContent":["import type { Core } from '@strapi/types';\nimport { errors, extendMiddlewareConfiguration } from '@strapi/utils';\n\nexport type HandlerParams = {\n  documentId: string;\n  locale: string;\n  status: 'published' | 'draft';\n};\n\n/**\n * @deprecated Use Core.Config.Admin['preview'] from @strapi/types instead\n * Keeping for backward compatibility\n */\nexport type PreviewConfig = NonNullable<Core.Config.Admin['preview']>;\n\n/**\n * Read configuration for static preview\n */\nconst createPreviewConfigService = ({ strapi }: { strapi: Core.Strapi }) => {\n  return {\n    register() {\n      if (!this.isEnabled()) {\n        return;\n      }\n\n      const config = strapi.config.get('admin.preview') as PreviewConfig;\n\n      /**\n       * Register the allowed origins for CSP, so the preview URL can be displayed\n       */\n      if (config.config?.allowedOrigins) {\n        const middlewares = strapi.config.get('middlewares') as (\n          | string\n          | { name?: string; config?: any }\n        )[];\n\n        const configuredMiddlewares = extendMiddlewareConfiguration(middlewares, {\n          name: 'strapi::security',\n          config: {\n            contentSecurityPolicy: {\n              directives: {\n                'frame-src': config.config.allowedOrigins,\n              },\n            },\n          },\n        });\n\n        strapi.config.set('middlewares', configuredMiddlewares);\n      }\n    },\n\n    isConfigured() {\n      const config = strapi.config.get('admin.preview') as PreviewConfig;\n      return config?.enabled === false || config?.config?.handler != null;\n    },\n\n    isEnabled() {\n      const config = strapi.config.get('admin.preview') as PreviewConfig;\n\n      if (!config) {\n        return false;\n      }\n\n      return config?.enabled ?? true;\n    },\n\n    /**\n     * Validate if the configuration is valid\n     */\n    validate() {\n      if (!this.isEnabled()) {\n        return;\n      }\n\n      const handler = this.getPreviewHandler();\n\n      // Handler must be a function\n      if (typeof handler !== 'function') {\n        throw new errors.ValidationError(\n          'Preview configuration is invalid. Handler must be a function'\n        );\n      }\n    },\n\n    /**\n     * Utility to get the preview handler from the configuration\n     */\n    getPreviewHandler(): NonNullable<Core.Config.Admin['preview']>['config']['handler'] {\n      const emptyHandler = () => {\n        return undefined;\n      };\n\n      if (!this.isEnabled()) {\n        return emptyHandler;\n      }\n\n      const config = strapi.config.get('admin.preview') as PreviewConfig;\n\n      return config?.config?.handler || emptyHandler;\n    },\n  };\n};\n\nexport { createPreviewConfigService };\n"],"names":["createPreviewConfigService","strapi","register","isEnabled","config","get","allowedOrigins","middlewares","configuredMiddlewares","extendMiddlewareConfiguration","name","contentSecurityPolicy","directives","set","isConfigured","enabled","handler","validate","getPreviewHandler","errors","ValidationError","emptyHandler","undefined"],"mappings":";;AAeA;;AAEC,IACKA,MAAAA,0BAAAA,GAA6B,CAAC,EAAEC,MAAM,EAA2B,GAAA;IACrE,OAAO;AACLC,QAAAA,QAAAA,CAAAA,GAAAA;AACE,YAAA,IAAI,CAAC,IAAI,CAACC,SAAS,EAAI,EAAA;AACrB,gBAAA;AACF;AAEA,YAAA,MAAMC,MAASH,GAAAA,MAAAA,CAAOG,MAAM,CAACC,GAAG,CAAC,eAAA,CAAA;AAEjC;;AAEC,UACD,IAAID,MAAAA,CAAOA,MAAM,EAAEE,cAAgB,EAAA;AACjC,gBAAA,MAAMC,WAAcN,GAAAA,MAAAA,CAAOG,MAAM,CAACC,GAAG,CAAC,aAAA,CAAA;gBAKtC,MAAMG,qBAAAA,GAAwBC,8BAA8BF,WAAa,EAAA;oBACvEG,IAAM,EAAA,kBAAA;oBACNN,MAAQ,EAAA;wBACNO,qBAAuB,EAAA;4BACrBC,UAAY,EAAA;gCACV,WAAaR,EAAAA,MAAAA,CAAOA,MAAM,CAACE;AAC7B;AACF;AACF;AACF,iBAAA,CAAA;AAEAL,gBAAAA,MAAAA,CAAOG,MAAM,CAACS,GAAG,CAAC,aAAeL,EAAAA,qBAAAA,CAAAA;AACnC;AACF,SAAA;AAEAM,QAAAA,YAAAA,CAAAA,GAAAA;AACE,YAAA,MAAMV,MAASH,GAAAA,MAAAA,CAAOG,MAAM,CAACC,GAAG,CAAC,eAAA,CAAA;AACjC,YAAA,OAAOD,MAAQW,EAAAA,OAAAA,KAAY,KAASX,IAAAA,MAAAA,EAAQA,QAAQY,OAAW,IAAA,IAAA;AACjE,SAAA;AAEAb,QAAAA,SAAAA,CAAAA,GAAAA;AACE,YAAA,MAAMC,MAASH,GAAAA,MAAAA,CAAOG,MAAM,CAACC,GAAG,CAAC,eAAA,CAAA;AAEjC,YAAA,IAAI,CAACD,MAAQ,EAAA;gBACX,OAAO,KAAA;AACT;AAEA,YAAA,OAAOA,QAAQW,OAAW,IAAA,IAAA;AAC5B,SAAA;AAEA;;QAGAE,QAAAA,CAAAA,GAAAA;AACE,YAAA,IAAI,CAAC,IAAI,CAACd,SAAS,EAAI,EAAA;AACrB,gBAAA;AACF;YAEA,MAAMa,OAAAA,GAAU,IAAI,CAACE,iBAAiB,EAAA;;YAGtC,IAAI,OAAOF,YAAY,UAAY,EAAA;gBACjC,MAAM,IAAIG,MAAOC,CAAAA,eAAe,CAC9B,8DAAA,CAAA;AAEJ;AACF,SAAA;AAEA;;QAGAF,iBAAAA,CAAAA,GAAAA;AACE,YAAA,MAAMG,YAAe,GAAA,IAAA;gBACnB,OAAOC,SAAAA;AACT,aAAA;AAEA,YAAA,IAAI,CAAC,IAAI,CAACnB,SAAS,EAAI,EAAA;gBACrB,OAAOkB,YAAAA;AACT;AAEA,YAAA,MAAMjB,MAASH,GAAAA,MAAAA,CAAOG,MAAM,CAACC,GAAG,CAAC,eAAA,CAAA;YAEjC,OAAOD,MAAAA,EAAQA,QAAQY,OAAWK,IAAAA,YAAAA;AACpC;AACF,KAAA;AACF;;;;"}