{"version":3,"file":"ai-localizations.js","sources":["../../../server/src/services/ai-localizations.ts"],"sourcesContent":["import type { Core, Modules, Schema, UID } from '@strapi/types';\nimport { traverseEntity } from '@strapi/utils';\nimport { getService } from '../utils';\n\nconst isLocalizedAttribute = (attribute: Schema.Attribute.Attribute | undefined): boolean => {\n  return (attribute?.pluginOptions as any)?.i18n?.localized === true;\n};\n\nconst createAILocalizationsService = ({ strapi }: { strapi: Core.Strapi }) => {\n  // TODO: add a helper function to get the AI server URL\n  const aiServerUrl = process.env.STRAPI_AI_URL || 'https://strapi-ai.apps.strapi.io';\n  const aiLocalizationJobsService = getService('ai-localization-jobs');\n\n  const UNSUPPORTED_ATTRIBUTE_TYPES: Schema.Attribute.Kind[] = [\n    'media',\n    'relation',\n    'boolean',\n    'enumeration',\n  ];\n  const IGNORED_FIELDS = [\n    'id',\n    'documentId',\n    'createdAt',\n    'updatedAt',\n    'updatedBy',\n    'localizations',\n  ];\n\n  return {\n    // Async to avoid changing the signature later (there will be a db check in the future)\n    async isEnabled() {\n      // Check if user disabled AI features globally\n      const isAIEnabled = strapi.config.get('admin.ai.enabled', true);\n      if (!isAIEnabled) {\n        return false;\n      }\n\n      // Check if the user's license grants access to AI features\n      const hasAccess = strapi.ee.features.isEnabled('cms-ai');\n      if (!hasAccess) {\n        return false;\n      }\n\n      const settings = getService('settings');\n      const aiSettings = await settings.getSettings();\n      if (!aiSettings?.aiLocalizations) {\n        return false;\n      }\n\n      return true;\n    },\n\n    /**\n     * Checks if there are localizations that need to be generated for the given document,\n     * and if so, calls the AI service and saves the results to the database.\n     * Works for both single and collection types, on create and update.\n     */\n    async generateDocumentLocalizations({\n      model,\n      document,\n    }: {\n      model: UID.ContentType;\n      document: Modules.Documents.AnyDocument;\n    }) {\n      const isFeatureEnabled = await this.isEnabled();\n      if (!isFeatureEnabled) {\n        return;\n      }\n\n      const schema = strapi.getModel(model);\n      const localeService = getService('locales');\n\n      // No localizations needed for content types with i18n disabled\n      const isLocalizedContentType = getService('content-types').isLocalizedContentType(schema);\n      if (!isLocalizedContentType) {\n        return;\n      }\n\n      // Don't trigger localizations if the update is on a derived locale, only do it on the default\n      const defaultLocale = await localeService.getDefaultLocale();\n      if (document?.locale !== defaultLocale) {\n        return;\n      }\n\n      const documentId = document.documentId;\n\n      if (!documentId) {\n        strapi.log.warn(`AI Localizations: missing documentId for ${schema.uid}`);\n        return;\n      }\n\n      const localizedRoots = new Set();\n\n      const translateableContent = await traverseEntity(\n        ({ key, attribute, parent, path }, { remove }) => {\n          if (IGNORED_FIELDS.includes(key)) {\n            remove(key);\n            return;\n          }\n          const hasLocalizedOption = attribute && isLocalizedAttribute(attribute);\n          if (attribute && UNSUPPORTED_ATTRIBUTE_TYPES.includes(attribute.type)) {\n            remove(key);\n            return;\n          }\n\n          // If this field is localized, keep it (and mark as localized root if component/dz)\n          if (hasLocalizedOption) {\n            // If it's a component/dynamiczone, add to the set\n            if (['component', 'dynamiczone'].includes(attribute.type)) {\n              localizedRoots.add(path.raw);\n            }\n            return; // keep\n          }\n\n          if (parent && localizedRoots.has(parent.path.raw)) {\n            // If parent exists in the localized roots set, keep it\n            // If this is also a component/dz, propagate the localized root flag\n            if (['component', 'dynamiczone'].includes(attribute?.type ?? '')) {\n              localizedRoots.add(path.raw);\n            }\n            return; // keep\n          }\n\n          // Otherwise, remove the field\n          remove(key);\n        },\n        { schema, getModel: strapi.getModel.bind(strapi) },\n        document\n      );\n\n      if (Object.keys(translateableContent).length === 0) {\n        strapi.log.info(\n          `AI Localizations: no translatable content for ${schema.uid} document ${documentId}`\n        );\n        return;\n      }\n\n      const localesList = await localeService.find();\n      const targetLocales = localesList\n        .filter((l) => l.code !== document.locale)\n        .map((l) => l.code);\n\n      if (targetLocales.length === 0) {\n        strapi.log.info(\n          `AI Localizations: no target locales for ${schema.uid} document ${documentId}`\n        );\n        return;\n      }\n\n      await aiLocalizationJobsService.upsertJobForDocument({\n        contentType: model,\n        documentId,\n        sourceLocale: document.locale,\n        targetLocales,\n        status: 'processing',\n      });\n\n      let token: string;\n      try {\n        const tokenData = await strapi.get('ai').getAiToken();\n        token = tokenData.token;\n      } catch (error) {\n        await aiLocalizationJobsService.upsertJobForDocument({\n          documentId,\n          contentType: model,\n          sourceLocale: document.locale,\n          targetLocales,\n          status: 'failed',\n        });\n\n        throw new Error('Failed to retrieve AI token', {\n          cause: error instanceof Error ? error : undefined,\n        });\n      }\n\n      /**\n       * Provide a schema to the LLM so that we can give it instructions about how to handle each\n       * type of attribute. Only keep essential schema data to avoid cluttering the context.\n       * Ignore fields that don't need to be localized.\n       * TODO: also provide a schema of all the referenced components\n       */\n      const minimalContentTypeSchema = Object.fromEntries(\n        Object.entries(schema.attributes)\n          // eslint-disable-next-line @typescript-eslint/no-unused-vars\n          .filter(([_, attr]) => {\n            const isLocalized = isLocalizedAttribute(attr);\n            const isSupportedType = !UNSUPPORTED_ATTRIBUTE_TYPES.includes(attr.type);\n            return isLocalized && isSupportedType;\n          })\n          .map(([key, attr]) => {\n            const minimalAttribute = { type: attr.type };\n            if (attr.type === 'component') {\n              (\n                minimalAttribute as Schema.Attribute.Component<`${string}.${string}`, boolean>\n              ).repeatable = attr.repeatable ?? false;\n            }\n            return [key, minimalAttribute];\n          })\n      );\n\n      strapi.log.http('Contacting AI Server for localizations generation');\n      const response = await fetch(`${aiServerUrl}/i18n/generate-localizations`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${token}`,\n        },\n        body: JSON.stringify({\n          content: translateableContent,\n          sourceLocale: document.locale,\n          targetLocales,\n          contentTypeSchema: minimalContentTypeSchema,\n        }),\n      });\n\n      if (!response.ok) {\n        strapi.log.error(\n          `AI Localizations request failed: ${response.status} ${response.statusText}`\n        );\n\n        await aiLocalizationJobsService.upsertJobForDocument({\n          documentId,\n          contentType: model,\n          sourceLocale: document.locale,\n          targetLocales,\n          status: 'failed',\n        });\n\n        throw new Error(`AI Localizations request failed: ${response.statusText}`);\n      }\n\n      const aiResult = await response.json();\n      // Get all media field names dynamically from the schema\n      const mediaFields = Object.entries(schema.attributes)\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\n        .filter(([_, attr]) => attr.type === 'media')\n        .map(([key]) => key);\n\n      try {\n        await Promise.all(\n          aiResult.localizations.map(async (localization: any) => {\n            const { content, locale } = localization;\n\n            // Fetch the derived locale document\n            const derivedDoc = await strapi.documents(model).findOne({\n              documentId,\n              locale,\n              populate: mediaFields,\n            });\n\n            // Merge AI content and media fields, works only on first level media fields (root level)\n            const mergedData = structuredClone(content);\n            for (const field of mediaFields) {\n              // Only copy media if not already set in derived locale\n              if (!derivedDoc || !derivedDoc[field]) {\n                mergedData[field] = document[field];\n              } else {\n                mergedData[field] = derivedDoc[field];\n              }\n            }\n\n            await strapi.documents(model).update({\n              documentId,\n              locale,\n              fields: [],\n              data: mergedData,\n            });\n\n            await aiLocalizationJobsService.upsertJobForDocument({\n              documentId,\n              contentType: model,\n              sourceLocale: document.locale,\n              targetLocales,\n              status: 'completed',\n            });\n          })\n        );\n      } catch (error) {\n        await aiLocalizationJobsService.upsertJobForDocument({\n          documentId,\n          contentType: model,\n          sourceLocale: document.locale,\n          targetLocales,\n          status: 'failed',\n        });\n        strapi.log.error('AI Localizations generation failed', error);\n      }\n    },\n    setupMiddleware() {\n      strapi.documents.use(async (context, next) => {\n        const result = await next();\n\n        // Only trigger for the allowed actions\n        if (!['create', 'update'].includes(context.action)) {\n          return result;\n        }\n\n        // Check if AI localizations are enabled before triggering\n        const isEnabled = await this.isEnabled();\n        if (!isEnabled) {\n          return result;\n        }\n\n        // Don't await since localizations should be done in the background without blocking the request\n        strapi\n          .plugin('i18n')\n          .service('ai-localizations')\n          .generateDocumentLocalizations({\n            model: context.contentType.uid,\n            document: result,\n          })\n          .catch((error: any) => {\n            strapi.log.error('AI Localizations generation failed', error);\n          });\n\n        return result;\n      });\n    },\n  };\n};\n\nexport { createAILocalizationsService };\n"],"names":["isLocalizedAttribute","attribute","pluginOptions","i18n","localized","createAILocalizationsService","strapi","aiServerUrl","process","env","STRAPI_AI_URL","aiLocalizationJobsService","getService","UNSUPPORTED_ATTRIBUTE_TYPES","IGNORED_FIELDS","isEnabled","isAIEnabled","config","get","hasAccess","ee","features","settings","aiSettings","getSettings","aiLocalizations","generateDocumentLocalizations","model","document","isFeatureEnabled","schema","getModel","localeService","isLocalizedContentType","defaultLocale","getDefaultLocale","locale","documentId","log","warn","uid","localizedRoots","Set","translateableContent","traverseEntity","key","parent","path","remove","includes","hasLocalizedOption","type","add","raw","has","bind","Object","keys","length","info","localesList","find","targetLocales","filter","l","code","map","upsertJobForDocument","contentType","sourceLocale","status","token","tokenData","getAiToken","error","Error","cause","undefined","minimalContentTypeSchema","fromEntries","entries","attributes","_","attr","isLocalized","isSupportedType","minimalAttribute","repeatable","http","response","fetch","method","headers","Authorization","body","JSON","stringify","content","contentTypeSchema","ok","statusText","aiResult","json","mediaFields","Promise","all","localizations","localization","derivedDoc","documents","findOne","populate","mergedData","structuredClone","field","update","fields","data","setupMiddleware","use","context","next","result","action","plugin","service","catch"],"mappings":"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"}