{"version":3,"file":"ai.js","sources":["../../../../../../../ee/server/src/ai/containers/ai.ts"],"sourcesContent":["import type { Core } from '@strapi/types';\nimport crypto from 'crypto';\nimport fs from 'fs';\nimport path from 'path';\nimport { AdminUser } from '../../../../../shared/contracts/shared';\n\n/**\n * In-memory cache for AI tokens\n * Key format: `${projectId}:${userId}`\n */\nconst aiTokenCache = new Map<\n  string,\n  {\n    token: string;\n    expiresAt?: string;\n    expiresAtMs?: number;\n  }\n>();\n\nconst createAIContainer = ({ strapi }: { strapi: Core.Strapi }) => {\n  const getAIFeatureConfig = async () => {\n    const i18nSettings = await strapi.plugin('i18n').service('settings').getSettings();\n    const uploadSettings = await strapi.plugin('upload').service('upload').getSettings();\n\n    return {\n      isAIi18nConfigured: Boolean(i18nSettings?.aiLocalizations),\n      isAIMediaLibraryConfigured: Boolean(uploadSettings?.aiMetadata),\n    };\n  };\n\n  const getAiToken = async () => {\n    const ERROR_PREFIX = 'AI token request failed:';\n\n    // Check if EE features are enabled first\n    if (!strapi.ee?.isEE) {\n      strapi.log.error(`${ERROR_PREFIX} Enterprise Edition features are not enabled`);\n      throw new Error('AI token request failed. Check server logs for details.');\n    }\n\n    // Get the EE license\n    // First try environment variable, then try reading from file\n    let eeLicense = process.env.STRAPI_LICENSE;\n\n    if (!eeLicense) {\n      try {\n        const licensePath = path.join(strapi.dirs.app.root, 'license.txt');\n        eeLicense = fs.readFileSync(licensePath).toString();\n      } catch (error) {\n        // License file doesn't exist or can't be read\n      }\n    }\n\n    if (!eeLicense) {\n      strapi.log.error(\n        `${ERROR_PREFIX} No EE license found. Please ensure STRAPI_LICENSE environment variable is set or license.txt file exists.`\n      );\n\n      throw new Error('AI token request failed. Check server logs for details.');\n    }\n\n    const aiServerUrl = process.env.STRAPI_AI_URL || 'https://strapi-ai.apps.strapi.io';\n\n    if (!aiServerUrl) {\n      strapi.log.error(\n        `${ERROR_PREFIX} AI server URL not configured. Please set STRAPI_AI_URL environment variable.`\n      );\n      throw new Error('AI token request failed. Check server logs for details.');\n    }\n\n    // Get the current user\n    const user = strapi.requestContext.get()?.state?.user as AdminUser | undefined;\n    if (!user) {\n      strapi.log.error(`${ERROR_PREFIX} No authenticated user in request context`);\n      throw new Error('AI token request failed. Check server logs for details.');\n    }\n\n    // Create a secure user identifier using only user ID\n    const userIdentifier = user.id.toString();\n\n    // Get project ID\n    const projectId = strapi.config.get('uuid');\n    if (!projectId) {\n      strapi.log.error(`${ERROR_PREFIX} Project ID not configured`);\n      throw new Error('AI token request failed. Check server logs for details.');\n    }\n\n    // Check cache for existing valid token\n    const cacheKey = `${projectId}:${userIdentifier}`;\n    const cachedToken = aiTokenCache.get(cacheKey);\n\n    if (cachedToken) {\n      const now = Date.now();\n      // Check if token is still valid (with buffer so it has time to  to be used)\n      const bufferMs = 2 * 60 * 1000; // 2 minutes\n\n      if (cachedToken.expiresAtMs && cachedToken.expiresAtMs - bufferMs > now) {\n        strapi.log.info('Using cached AI token');\n\n        return {\n          token: cachedToken.token,\n          expiresAt: cachedToken.expiresAt,\n        };\n      }\n\n      // Token expired or will expire soon, remove from cache\n      aiTokenCache.delete(cacheKey);\n    }\n\n    strapi.log.http('Contacting AI Server for token generation');\n\n    try {\n      // Call the AI server's getAiJWT endpoint\n      const response = await fetch(`${aiServerUrl}/auth/getAiJWT`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          // No authorization header needed for public endpoint\n          // Add request ID for tracing\n          'X-Request-Id': crypto.randomUUID(),\n        },\n        body: JSON.stringify({\n          eeLicense,\n          userIdentifier,\n          projectId,\n        }),\n      });\n\n      if (!response.ok) {\n        let errorData;\n        let errorText;\n        try {\n          errorText = await response.text();\n          errorData = JSON.parse(errorText);\n        } catch {\n          errorData = { error: errorText || 'Failed to parse error response' };\n        }\n\n        strapi.log.error(`${ERROR_PREFIX} ${errorData?.error || 'Unknown error'}`, {\n          status: response.status,\n          statusText: response.statusText,\n          error: errorData,\n          errorText,\n          projectId,\n        });\n\n        throw new Error('AI token request failed. Check server logs for details.');\n      }\n\n      let data;\n      try {\n        data = (await response.json()) as {\n          jwt: string;\n          expiresAt?: string;\n        };\n      } catch (parseError) {\n        strapi.log.error(`${ERROR_PREFIX} Failed to parse AI server response`, parseError);\n        throw new Error('AI token request failed. Check server logs for details.');\n      }\n\n      if (!data.jwt) {\n        strapi.log.error(`${ERROR_PREFIX} Invalid response: missing JWT token`);\n        throw new Error('AI token request failed. Check server logs for details.');\n      }\n\n      strapi.log.info('AI token generated successfully', {\n        userId: user.id,\n        expiresAt: data.expiresAt,\n      });\n\n      // Cache the token if it has an expiration time\n      if (data.expiresAt) {\n        const expiresAtMs = new Date(data.expiresAt).getTime();\n        aiTokenCache.set(cacheKey, {\n          token: data.jwt,\n          expiresAt: data.expiresAt,\n          expiresAtMs,\n        });\n      }\n\n      // Return the AI JWT with metadata\n      // Note: Token expires in 1 hour, client should handle refresh\n      return {\n        token: data.jwt,\n        expiresAt: data.expiresAt, // 1 hour from generation\n      };\n    } catch (fetchError) {\n      if (fetchError instanceof Error && fetchError.name === 'AbortError') {\n        strapi.log.error(`${ERROR_PREFIX} Request to AI server timed out`);\n        throw new Error('AI token request failed. Check server logs for details.');\n      }\n\n      throw fetchError;\n    }\n  };\n\n  return {\n    getAIFeatureConfig,\n    getAiToken,\n  };\n};\n\nexport { createAIContainer };\n"],"names":["aiTokenCache","Map","createAIContainer","strapi","getAIFeatureConfig","i18nSettings","plugin","service","getSettings","uploadSettings","isAIi18nConfigured","Boolean","aiLocalizations","isAIMediaLibraryConfigured","aiMetadata","getAiToken","ERROR_PREFIX","ee","isEE","log","error","Error","eeLicense","process","env","STRAPI_LICENSE","licensePath","path","join","dirs","app","root","fs","readFileSync","toString","aiServerUrl","STRAPI_AI_URL","user","requestContext","get","state","userIdentifier","id","projectId","config","cacheKey","cachedToken","now","Date","bufferMs","expiresAtMs","info","token","expiresAt","delete","http","response","fetch","method","headers","crypto","randomUUID","body","JSON","stringify","ok","errorData","errorText","text","parse","status","statusText","data","json","parseError","jwt","userId","getTime","set","fetchError","name"],"mappings":"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"}