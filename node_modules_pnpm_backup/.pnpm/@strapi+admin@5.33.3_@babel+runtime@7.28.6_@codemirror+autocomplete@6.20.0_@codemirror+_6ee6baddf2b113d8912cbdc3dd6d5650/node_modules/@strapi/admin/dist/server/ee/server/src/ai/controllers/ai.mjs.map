{"version":3,"file":"ai.mjs","sources":["../../../../../../../ee/server/src/ai/controllers/ai.ts"],"sourcesContent":["import type { Context } from 'koa';\nimport path from 'path';\nimport fs from 'fs';\nimport crypto from 'crypto';\nimport { GetAiToken } from '../../../../../shared/contracts/ai';\n\nexport default {\n  async getAiToken(ctx: Context) {\n    try {\n      // TODO: auth check is not necessary? Already protected by route middleware?\n      // Security check: Ensure user is authenticated and has proper permissions\n      if (!ctx.state.user) {\n        return ctx.unauthorized('Authentication required');\n      }\n\n      const aiToken = await strapi.get('ai').getAiToken();\n\n      ctx.body = {\n        data: aiToken,\n      } satisfies GetAiToken.Response;\n    } catch (error) {\n      const errorMessage = 'AI token request failed. Check server logs for details.';\n      return ctx.internalServerError(errorMessage);\n    }\n  },\n\n  async getAiUsage(ctx: Context) {\n    const ERROR_PREFIX = 'AI usage data request failed:';\n    const USER_ERROR_MESSAGE = 'AI usage data request failed. Check server logs for details.';\n    // Security check: Ensure user is authenticated and has proper permissions\n    if (!ctx.state.user) {\n      return ctx.unauthorized('Authentication required');\n    }\n\n    // Check if EE features are enabled first\n    if (!strapi.ee?.isEE) {\n      strapi.log.error(`${ERROR_PREFIX} Enterprise Edition features are not enabled`);\n      return ctx.internalServerError(USER_ERROR_MESSAGE);\n    }\n\n    // Get the EE license\n    // First try environment variable, then try reading from file\n    let eeLicense = process.env.STRAPI_LICENSE;\n\n    if (!eeLicense) {\n      try {\n        const licensePath = path.join(strapi.dirs.app.root, 'license.txt');\n        eeLicense = fs.readFileSync(licensePath).toString();\n      } catch (error) {\n        // License file doesn't exist or can't be read\n      }\n    }\n\n    if (!eeLicense) {\n      strapi.log.error(\n        `${ERROR_PREFIX} No EE license found. Please ensure STRAPI_LICENSE environment variable is set or license.txt file exists.`\n      );\n\n      return ctx.internalServerError(USER_ERROR_MESSAGE);\n    }\n\n    const aiServerUrl = process.env.STRAPI_AI_URL || 'https://strapi-ai.apps.strapi.io';\n\n    if (!aiServerUrl) {\n      strapi.log.error(\n        `${ERROR_PREFIX} AI server URL not configured. Please set STRAPI_AI_URL or STRAPI_AI_URL environment variable.`\n      );\n      return ctx.internalServerError(USER_ERROR_MESSAGE);\n    }\n\n    // Get project ID\n    const projectId = strapi.config.get('uuid');\n    if (!projectId) {\n      strapi.log.error(`${ERROR_PREFIX} Project ID not configured`);\n      return ctx.internalServerError(USER_ERROR_MESSAGE);\n    }\n\n    try {\n      // Call the AI server's getAiJWT endpoint\n      const response = await fetch(`${aiServerUrl}/cms/ai-data`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          // No authorization header needed for public endpoint\n          // Add request ID for tracing\n          'X-Request-Id': crypto.randomUUID(),\n        },\n        body: JSON.stringify({\n          eeKey: eeLicense,\n          projectId,\n        }),\n      });\n\n      if (!response.ok) {\n        let errorData;\n        let errorText;\n        try {\n          errorText = await response.text();\n          errorData = JSON.parse(errorText);\n        } catch {\n          errorData = { error: errorText || 'Failed to parse error response' };\n        }\n\n        strapi.log.error(`${ERROR_PREFIX} ${errorData?.error || 'Unknown error'}`, {\n          status: response.status,\n          statusText: response.statusText,\n          error: errorData,\n          errorText,\n          projectId,\n        });\n\n        return ctx.internalServerError(USER_ERROR_MESSAGE);\n      }\n\n      let data;\n      try {\n        data = (await response.json()) as {\n          data: {\n            cmsAiCreditsUsed: number;\n          };\n          subscription: {\n            subscriptionId: string;\n            planPriceId: string;\n            subscriptionStatus: string;\n            isActiveSubscription: boolean;\n            cmsAiEnabled: boolean;\n            cmsAiCreditsBase: number;\n            cmsAiCreditsMaxUsage: number;\n            currentTermStart: string;\n            currentTermEnd: string;\n          };\n        };\n      } catch (parseError) {\n        strapi.log.error(`${ERROR_PREFIX} Failed to parse AI server response`, parseError);\n        return ctx.internalServerError(USER_ERROR_MESSAGE);\n      }\n\n      ctx.body = {\n        ...data.data,\n        subscription: data.subscription,\n      };\n    } catch (fetchError) {\n      if (fetchError instanceof Error && fetchError.name === 'AbortError') {\n        strapi.log.error(`${ERROR_PREFIX} Request to AI server timed out`);\n        return ctx.internalServerError(USER_ERROR_MESSAGE);\n      }\n\n      throw fetchError;\n    }\n  },\n  async getAIFeatureConfig(ctx: Context) {\n    const aiFeatureConfig = await strapi.get('ai').getAIFeatureConfig();\n\n    ctx.body = {\n      data: aiFeatureConfig,\n    };\n  },\n};\n"],"names":["getAiToken","ctx","state","user","unauthorized","aiToken","strapi","get","body","data","error","errorMessage","internalServerError","getAiUsage","ERROR_PREFIX","USER_ERROR_MESSAGE","ee","isEE","log","eeLicense","process","env","STRAPI_LICENSE","licensePath","path","join","dirs","app","root","fs","readFileSync","toString","aiServerUrl","STRAPI_AI_URL","projectId","config","response","fetch","method","headers","crypto","randomUUID","JSON","stringify","eeKey","ok","errorData","errorText","text","parse","status","statusText","json","parseError","subscription","fetchError","Error","name","getAIFeatureConfig","aiFeatureConfig"],"mappings":"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"}