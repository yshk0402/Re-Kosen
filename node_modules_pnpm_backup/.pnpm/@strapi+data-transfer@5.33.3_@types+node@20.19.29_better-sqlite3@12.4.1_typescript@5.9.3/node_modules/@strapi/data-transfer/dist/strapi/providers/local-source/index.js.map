{"version":3,"file":"index.js","sources":["../../../../src/strapi/providers/local-source/index.ts"],"sourcesContent":["import { Readable } from 'stream';\nimport { chain } from 'stream-chain';\nimport type { Core, Struct } from '@strapi/types';\n\nimport type { IMetadata, ISourceProvider, ProviderType } from '../../../../types';\nimport type { IDiagnosticReporter } from '../../../utils/diagnostic';\nimport { createEntitiesStream, createEntitiesTransformStream } from './entities';\nimport { createLinksStream } from './links';\nimport { createConfigurationStream } from './configuration';\nimport { createAssetsStream } from './assets';\nimport * as utils from '../../../utils';\nimport { assertValidStrapi } from '../../../utils/providers';\n\nexport interface ILocalStrapiSourceProviderOptions {\n  getStrapi(): Core.Strapi | Promise<Core.Strapi>; // return an initialized instance of Strapi\n\n  autoDestroy?: boolean; // shut down the instance returned by getStrapi() at the end of the transfer\n}\n\nexport const createLocalStrapiSourceProvider = (options: ILocalStrapiSourceProviderOptions) => {\n  return new LocalStrapiSourceProvider(options);\n};\n\nclass LocalStrapiSourceProvider implements ISourceProvider {\n  name = 'source::local-strapi';\n\n  type: ProviderType = 'source';\n\n  options: ILocalStrapiSourceProviderOptions;\n\n  strapi?: Core.Strapi;\n\n  #diagnostics?: IDiagnosticReporter;\n\n  constructor(options: ILocalStrapiSourceProviderOptions) {\n    this.options = options;\n  }\n\n  async bootstrap(diagnostics?: IDiagnosticReporter): Promise<void> {\n    this.#diagnostics = diagnostics;\n    this.strapi = await this.options.getStrapi();\n    this.strapi.db.lifecycles.disable();\n  }\n\n  #reportInfo(message: string) {\n    this.#diagnostics?.report({\n      details: {\n        createdAt: new Date(),\n        message,\n        origin: 'local-source-provider',\n      },\n      kind: 'info',\n    });\n  }\n\n  /**\n   * Reports an error to the diagnostic reporter.\n   */\n  #reportError(message: string, error: Error) {\n    this.#diagnostics?.report({\n      details: {\n        createdAt: new Date(),\n        message,\n        error,\n        severity: 'fatal',\n        name: error.name,\n      },\n      kind: 'error',\n    });\n  }\n\n  /**\n   * Handles errors that occur in read streams.\n   */\n  #handleStreamError(streamType: string, err: Error) {\n    const { message, stack } = err;\n    const errorMessage = `[Data transfer] Error in ${streamType} read stream: ${message}`;\n    const formattedError = {\n      message: errorMessage,\n      stack,\n      timestamp: new Date().toISOString(),\n    };\n\n    this.strapi?.log.error(formattedError);\n    this.#reportError(formattedError.message, err);\n  }\n\n  async close(): Promise<void> {\n    const { autoDestroy } = this.options;\n    assertValidStrapi(this.strapi);\n    this.strapi.db.lifecycles.enable();\n    // Basically `!== false` but more deterministic\n    if (autoDestroy === undefined || autoDestroy === true) {\n      await this.strapi?.destroy();\n    }\n  }\n\n  getMetadata(): IMetadata {\n    this.#reportInfo('getting metadata');\n    const strapiVersion = strapi.config.get<string>('info.strapi');\n    const createdAt = new Date().toISOString();\n\n    return {\n      createdAt,\n      strapi: {\n        version: strapiVersion,\n      },\n    };\n  }\n\n  async createEntitiesReadStream(): Promise<Readable> {\n    assertValidStrapi(this.strapi, 'Not able to stream entities');\n    this.#reportInfo('creating entities read stream');\n    return chain([\n      // Entities stream\n      createEntitiesStream(this.strapi),\n\n      // Transform stream\n      createEntitiesTransformStream(),\n    ]);\n  }\n\n  createLinksReadStream(): Readable {\n    assertValidStrapi(this.strapi, 'Not able to stream links');\n    this.#reportInfo('creating links read stream');\n\n    return createLinksStream(this.strapi);\n  }\n\n  createConfigurationReadStream(): Readable {\n    assertValidStrapi(this.strapi, 'Not able to stream configuration');\n    this.#reportInfo('creating configuration read stream');\n    return createConfigurationStream(this.strapi);\n  }\n\n  getSchemas(): Record<string, Struct.Schema> {\n    assertValidStrapi(this.strapi, 'Not able to get Schemas');\n    this.#reportInfo('getting schemas');\n    const schemas = utils.schema.schemasToValidJSON({\n      ...this.strapi.contentTypes,\n      ...this.strapi.components,\n    });\n\n    return utils.schema.mapSchemasValues(schemas);\n  }\n\n  createSchemasReadStream(): Readable {\n    return Readable.from(Object.values(this.getSchemas()));\n  }\n\n  createAssetsReadStream(): Readable {\n    assertValidStrapi(this.strapi, 'Not able to stream assets');\n    this.#reportInfo('creating assets read stream');\n\n    const stream = createAssetsStream(this.strapi);\n    stream.on('error', (err) => {\n      this.#handleStreamError('assets', err);\n    });\n\n    return stream;\n  }\n}\n\nexport type ILocalStrapiSourceProvider = InstanceType<typeof LocalStrapiSourceProvider>;\n"],"names":["createLocalStrapiSourceProvider","options","LocalStrapiSourceProvider","bootstrap","diagnostics","strapi","getStrapi","db","lifecycles","disable","close","autoDestroy","assertValidStrapi","enable","undefined","destroy","getMetadata","strapiVersion","config","get","createdAt","Date","toISOString","version","createEntitiesReadStream","chain","createEntitiesStream","createEntitiesTransformStream","createLinksReadStream","createLinksStream","createConfigurationReadStream","createConfigurationStream","getSchemas","schemas","utils","contentTypes","components","createSchemasReadStream","Readable","from","Object","values","createAssetsReadStream","stream","createAssetsStream","on","err","name","type","message","report","details","origin","kind","error","severity","streamType","stack","errorMessage","formattedError","timestamp","log"],"mappings":"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"}